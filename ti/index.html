<html>
  <head>
    <style>
      .panel{
        width: 49%;
        display: inline-block;
        vertical-align: top;
      }
      .big{
        width: 100%;
      }
      .ltr{
        direction: ltr;
      }
    </style>
  </head>
  <body dir="rtl">
    <div id="d-info" class="panel"></div>
    <div class="panel">
      برنامه:
      <br>
      <textarea id="in-code" class="big ltr"></textarea>
      <br>
      ورودی:
      <br>
      <textarea id="in-inp" class="big ltr"></textarea>
      <br>
      <button id="b-test">تست</button>
      <button id="b-judge">داوری و رفتن به مرحله بعدی</button>
      <button id="b-skip">skip</button>
      <br>
      خروجی:
      <div id="l-out"></div>
    </div>
    <script>
      var tx = document.getElementsByTagName('textarea');
      for (var i = 0; i < tx.length; i++) {
        tx[i].setAttribute('style', 'height:' + (tx[i].scrollHeight) + 'px;overflow-y:hidden;');
        tx[i].addEventListener("input", OnInput, false);
      }

      function OnInput() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
      }
    </script>
    <script type="module">
      const $ = x => document.querySelector(x);
      $('#b-test').onclick = () => {
        const pattern = (code, input) => `(()=>{const main = ${code};return main(${input})})()`;
        try{
          $('#l-out').innerText = eval(pattern($('#in-code').value,$('#in-inp').value));
        }
        catch(e){
          alert(e);
        }
      };
      const getUrlParam = (x)=>{
        var url_string = window.location.href;
        var url = new URL(url_string);
        return url.searchParams.get(x);
      };
      const lessonId = getUrlParam('lesson');
      const nextLevel = (x) => {
        const mylevel = parseInt(window.localStorage.getItem(`level/ti/${x}`) || 0);
        window.localStorage.setItem(`level/ti/${x}`, mylevel+1);
        loadLesson(x);
      };
      $('#b-skip').onclick = () => nextLevel(lessonId);
      const loadLesson = async (x) => {
        const { value : levels } = await import(`./${x}.mjs`);
        const mylevel = parseInt(window.localStorage.getItem(`level/ti/${x}`) || 0);
        if (mylevel === levels.length) {
          window.localStorage.setItem(`lesson/ti/${x}`, 'done');
          window.location = "../";
          return;
        }
        const l = levels[mylevel];
        $('#d-info').innerHTML = 
          `<h1>${l.title}</h1>${l.text.map(x=>`<p>${x}</p>`).join('')}`;
        $('#in-code').value = l.default.code;
        $('#in-inp') .value = l.default.input;
        $('#b-judge').onclick = () => {
          const ca = eval($('#in-code').value);
          const res = l.test.find(x=>String(ca(...x))!==String(l.judge(...x)));
          if (res==undefined) {
            nextLevel(x);
            return;
          }
          else {
            alert(`پاسخ شما نادرست است`);
          }
        };
      };
      loadLesson(lessonId);
    </script>
  </body>
</html>